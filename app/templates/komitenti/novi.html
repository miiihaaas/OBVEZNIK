{% extends "base.html" %}
{% from "macros/breadcrumbs.html" import render_breadcrumbs %}
{% from "macros/form_field.html" import render_field, render_textarea %}

{% block title %}Dodaj Komitenta - OBVEZNIK{% endblock %}

{% block breadcrumbs %}
{{ render_breadcrumbs([
    {'text': 'Dashboard', 'url': url_for('dashboard.pausalac_dashboard') if current_user.role != 'admin' else url_for('admin_dashboard.dashboard')},
    {'text': 'Komitenti', 'url': url_for('komitenti.lista')},
    {'text': 'Novi Komitent', 'url': ''}
]) }}
{% endblock %}

{% block content %}
<div class="container mt-4 mb-5" id="komitentFormContainer"
     data-nbs-lookup-url="{{ url_for('komitenti.nbs_firma_lookup', pib='') }}">
    <div class="d-flex align-items-center mb-4">
        <div class="bg-light rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 60px; height: 60px;">
            <i class="fa-solid fa-user-plus fs-3 text-muted"></i>
        </div>
        <div>
            <h1 class="mb-1">Dodaj Novog Komitenta</h1>
            <p class="text-muted mb-0">Unesite podatke novog komitenta.</p>
        </div>
    </div>

    <form method="POST" action="{{ url_for('komitenti.novi') }}">
        {{ form.hidden_tag() }}

        <!-- PIB Search Section -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-bottom">
                <h5 class="mb-0"><i class="fa-solid fa-search me-2 text-success"></i> Pretraga PIB-a</h5>
            </div>
            <div class="card-body p-4">
                <div class="row g-3">
                    <div class="col-md-8">
                        <label for="pib" class="form-label fw-semibold">
                            <i class="fa-solid fa-hashtag me-1 text-muted"></i> PIB *
                        </label>
                        <div class="input-group input-group-lg">
                            <span class="input-group-text bg-light">
                                <i class="fa-solid fa-hashtag text-muted"></i>
                            </span>
                            {{ form.pib(class="form-control" ~ (" is-invalid" if form.pib.errors else ""), id="pib", placeholder="Unesite PIB (8 ili 9 cifara)") }}
                            {% if form.pib.errors %}
                                <div class="invalid-feedback">
                                    {{ form.pib.errors[0] }}
                                </div>
                            {% endif %}
                        </div>
                        <small class="form-text text-muted">Unesite PIB i kliknite "Pretraži NBS" da automatski učitate podatke.</small>
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="button" id="nbsSearchBtn" class="btn btn-success btn-lg w-100 shadow-sm">
                            <i class="fa-solid fa-magnifying-glass me-2"></i> Pretraži NBS
                        </button>
                    </div>
                </div>
                <div id="nbsAlert" class="alert mt-3" role="alert" style="display: none;"></div>
            </div>
        </div>

        <!-- Company Basic Info -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-bottom">
                <h5 class="mb-0"><i class="fa-solid fa-building me-2 text-primary"></i> Osnovni Podaci</h5>
            </div>
            <div class="card-body p-4">
                <div class="row g-3">
                    {{ render_field(
                        field=form.naziv,
                        label='Naziv Komitenta',
                        icon='fa-solid fa-building',
                        required=True,
                        size='large',
                        placeholder='Unesite naziv komitenta',
                        col_class='col-md-12'
                    ) }}

                    {{ render_field(
                        field=form.maticni_broj,
                        label='Matični Broj',
                        icon='fa-solid fa-id-card',
                        required=True,
                        size='large',
                        placeholder='Matični broj',
                        col_class='col-md-6'
                    ) }}
                </div>
            </div>
        </div>

        <!-- Address Info -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-bottom">
                <h5 class="mb-0"><i class="fa-solid fa-map-marker-alt me-2 text-success"></i> Adresa</h5>
            </div>
            <div class="card-body p-4">
                <div class="row g-3">
                    {{ render_field(
                        field=form.adresa,
                        label='Ulica',
                        icon='fa-solid fa-road',
                        required=True,
                        size='large',
                        placeholder='Naziv ulice',
                        col_class='col-md-8'
                    ) }}

                    {{ render_field(
                        field=form.broj,
                        label='Broj',
                        icon='fa-solid fa-hashtag',
                        required=True,
                        size='large',
                        placeholder='Broj',
                        col_class='col-md-4'
                    ) }}

                    {{ render_field(
                        field=form.postanski_broj,
                        label='Poštanski Broj',
                        icon='fa-solid fa-envelope',
                        required=True,
                        size='large',
                        placeholder='Poštanski broj',
                        col_class='col-md-4'
                    ) }}

                    {{ render_field(
                        field=form.mesto,
                        label='Mesto',
                        icon='fa-solid fa-city',
                        required=True,
                        size='large',
                        placeholder='Naziv mesta',
                        col_class='col-md-4'
                    ) }}

                    {{ render_field(
                        field=form.drzava,
                        label='Država',
                        icon='fa-solid fa-flag',
                        required=True,
                        size='large',
                        placeholder='Država',
                        col_class='col-md-4'
                    ) }}
                </div>
            </div>
        </div>

        <!-- Contact Info -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-bottom">
                <h5 class="mb-0"><i class="fa-solid fa-address-card me-2 text-info"></i> Kontakt Informacije</h5>
            </div>
            <div class="card-body p-4">
                <div class="row g-3">
                    {{ render_field(
                        field=form.email,
                        label='Email',
                        icon='fa-solid fa-envelope',
                        required=True,
                        size='large',
                        placeholder='email@primer.com',
                        col_class='col-md-12'
                    ) }}

                    {{ render_field(
                        field=form.kontakt_osoba,
                        label='Kontakt Osoba (opciono)',
                        icon='fa-solid fa-user',
                        help_text='Ime i prezime kontakt osobe u firmi (opciono).',
                        size='large',
                        placeholder='Ime i prezime kontakt osobe',
                        col_class='col-md-12'
                    ) }}

                    {{ render_textarea(
                        field=form.napomene,
                        label='Dodatne Napomene (opciono)',
                        icon='fa-solid fa-sticky-note',
                        help_text='Dodatne napomene o komitentu (opciono).',
                        rows=3,
                        placeholder='Unesite dodatne napomene o komitentu',
                        col_class='col-md-12'
                    ) }}
                </div>
            </div>
        </div>

        <!-- Dinarski Računi -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-bottom">
                <h5 class="mb-0"><i class="fa-solid fa-money-bill me-2 text-warning"></i> Dinarski Računi (opciono)</h5>
            </div>
            <div class="card-body p-4">
                <div id="dinarskiRacuniContainer"></div>
                <button type="button" id="addDinarskiRacun" class="btn btn-outline-primary mt-3">
                    <i class="fa-solid fa-plus me-2"></i> Dodaj Dinarski Račun
                </button>
            </div>
        </div>

        <!-- Devizni Računi -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-bottom">
                <h5 class="mb-0"><i class="fa-solid fa-dollar-sign me-2 text-success"></i> Devizni Računi</h5>
            </div>
            <div class="card-body p-4">
                <div class="alert alert-info">
                    <i class="fa-solid fa-info-circle me-2"></i>
                    <strong>Napomena:</strong> Bar jedan devizni račun je obavezan za kreiranje deviznih faktura.
                </div>
                <div id="devizniRacuniContainer"></div>
                <button type="button" id="addDevizniRacun" class="btn btn-outline-success mt-3">
                    <i class="fa-solid fa-plus me-2"></i> Dodaj Devizni Račun
                </button>
            </div>
        </div>

        <!-- Hidden fields for JSON data -->
        {{ form.dinarski_racuni_json }}
        {{ form.devizni_racuni_json }}

        <!-- Submit Buttons -->
        <div class="card border-0 shadow-sm">
            <div class="card-body p-4">
                <div class="d-flex flex-wrap gap-2">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fa-solid fa-save me-2"></i> Sačuvaj Komitenta
                    </button>
                    <a href="{{ url_for('komitenti.lista') }}" class="btn btn-outline-secondary btn-lg">
                        <i class="fa-solid fa-times me-2"></i> Otkaži
                    </a>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Komitent Form External JS -->
<script src="{{ url_for('static', filename='js/komitent-form.js') }}"></script>
{% endblock %}

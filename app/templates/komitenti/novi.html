{% extends "base.html" %}

{% block title %}Dodaj Komitenta - OBVEZNIK{% endblock %}

{% block content %}
<div class="container mt-4 mb-5">
    <div class="d-flex align-items-center mb-4">
        <div class="bg-light rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 60px; height: 60px;">
            <i class="fa-solid fa-user-plus fs-3 text-muted"></i>
        </div>
        <div>
            <h1 class="mb-1">Dodaj Novog Komitenta</h1>
            <p class="text-muted mb-0">Unesite podatke novog komitenta.</p>
        </div>
    </div>

    <form method="POST" action="{{ url_for('komitenti.novi') }}">
        {{ form.hidden_tag() }}

        <!-- PIB Search Section -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-bottom">
                <h5 class="mb-0"><i class="fa-solid fa-search me-2 text-success"></i> Pretraga PIB-a</h5>
            </div>
            <div class="card-body p-4">
                <div class="row g-3">
                    <div class="col-md-8">
                        <label for="pib" class="form-label fw-semibold">
                            <i class="fa-solid fa-hashtag me-1 text-muted"></i> PIB *
                        </label>
                        <div class="input-group input-group-lg">
                            <span class="input-group-text bg-light">
                                <i class="fa-solid fa-hashtag text-muted"></i>
                            </span>
                            {{ form.pib(class="form-control" ~ (" is-invalid" if form.pib.errors else ""), id="pib", placeholder="Unesite PIB (8 ili 9 cifara)") }}
                            {% if form.pib.errors %}
                                <div class="invalid-feedback">
                                    {{ form.pib.errors[0] }}
                                </div>
                            {% endif %}
                        </div>
                        <small class="form-text text-muted">Unesite PIB i kliknite "Pretraži NBS" da automatski učitate podatke.</small>
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="button" id="nbsSearchBtn" class="btn btn-success btn-lg w-100 shadow-sm">
                            <i class="fa-solid fa-magnifying-glass me-2"></i> Pretraži NBS
                        </button>
                    </div>
                </div>
                <div id="nbsAlert" class="alert mt-3" role="alert" style="display: none;"></div>
            </div>
        </div>

        <!-- Company Basic Info -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-bottom">
                <h5 class="mb-0"><i class="fa-solid fa-building me-2 text-primary"></i> Osnovni Podaci</h5>
            </div>
            <div class="card-body p-4">
                <div class="row g-3">
                    <div class="col-md-12">
                        <label for="naziv" class="form-label fw-semibold">
                            <i class="fa-solid fa-building me-1 text-muted"></i> Naziv Komitenta *
                        </label>
                        {{ form.naziv(class="form-control form-control-lg" ~ (" is-invalid" if form.naziv.errors else ""), id="naziv", placeholder="Unesite naziv komitenta") }}
                        {% if form.naziv.errors %}
                            <div class="invalid-feedback">{{ form.naziv.errors[0] }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <label for="maticni_broj" class="form-label fw-semibold">
                            <i class="fa-solid fa-id-card me-1 text-muted"></i> Matični Broj *
                        </label>
                        {{ form.maticni_broj(class="form-control form-control-lg" ~ (" is-invalid" if form.maticni_broj.errors else ""), id="maticni_broj", placeholder="Matični broj") }}
                        {% if form.maticni_broj.errors %}
                            <div class="invalid-feedback">{{ form.maticni_broj.errors[0] }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Address Info -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-bottom">
                <h5 class="mb-0"><i class="fa-solid fa-map-marker-alt me-2 text-success"></i> Adresa</h5>
            </div>
            <div class="card-body p-4">
                <div class="row g-3">
                    <div class="col-md-8">
                        <label for="adresa" class="form-label fw-semibold">
                            <i class="fa-solid fa-road me-1 text-muted"></i> Ulica *
                        </label>
                        {{ form.adresa(class="form-control form-control-lg" ~ (" is-invalid" if form.adresa.errors else ""), id="adresa", placeholder="Naziv ulice") }}
                        {% if form.adresa.errors %}
                            <div class="invalid-feedback">{{ form.adresa.errors[0] }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-4">
                        <label for="broj" class="form-label fw-semibold">
                            <i class="fa-solid fa-hashtag me-1 text-muted"></i> Broj *
                        </label>
                        {{ form.broj(class="form-control form-control-lg" ~ (" is-invalid" if form.broj.errors else ""), id="broj", placeholder="Broj") }}
                        {% if form.broj.errors %}
                            <div class="invalid-feedback">{{ form.broj.errors[0] }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-4">
                        <label for="postanski_broj" class="form-label fw-semibold">
                            <i class="fa-solid fa-envelope me-1 text-muted"></i> Poštanski Broj *
                        </label>
                        {{ form.postanski_broj(class="form-control form-control-lg" ~ (" is-invalid" if form.postanski_broj.errors else ""), id="postanski_broj", placeholder="Poštanski broj") }}
                        {% if form.postanski_broj.errors %}
                            <div class="invalid-feedback">{{ form.postanski_broj.errors[0] }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-4">
                        <label for="mesto" class="form-label fw-semibold">
                            <i class="fa-solid fa-city me-1 text-muted"></i> Mesto *
                        </label>
                        {{ form.mesto(class="form-control form-control-lg" ~ (" is-invalid" if form.mesto.errors else ""), id="mesto", placeholder="Naziv mesta") }}
                        {% if form.mesto.errors %}
                            <div class="invalid-feedback">{{ form.mesto.errors[0] }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-4">
                        <label for="drzava" class="form-label fw-semibold">
                            <i class="fa-solid fa-flag me-1 text-muted"></i> Država *
                        </label>
                        {{ form.drzava(class="form-control form-control-lg" ~ (" is-invalid" if form.drzava.errors else ""), id="drzava", placeholder="Država") }}
                        {% if form.drzava.errors %}
                            <div class="invalid-feedback">{{ form.drzava.errors[0] }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Contact Info -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-bottom">
                <h5 class="mb-0"><i class="fa-solid fa-address-card me-2 text-info"></i> Kontakt Informacije</h5>
            </div>
            <div class="card-body p-4">
                <div class="row g-3">
                    <div class="col-md-12">
                        <label for="email" class="form-label fw-semibold">
                            <i class="fa-solid fa-envelope me-1 text-muted"></i> Email *
                        </label>
                        {{ form.email(class="form-control form-control-lg" ~ (" is-invalid" if form.email.errors else ""), id="email", placeholder="email@primer.com") }}
                        {% if form.email.errors %}
                            <div class="invalid-feedback">{{ form.email.errors[0] }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-12">
                        <label for="kontakt_osoba" class="form-label fw-semibold">
                            <i class="fa-solid fa-user me-1 text-muted"></i> Kontakt Osoba (opciono)
                        </label>
                        {{ form.kontakt_osoba(class="form-control form-control-lg" ~ (" is-invalid" if form.kontakt_osoba.errors else ""), id="kontakt_osoba", placeholder="Ime i prezime kontakt osobe") }}
                        {% if form.kontakt_osoba.errors %}
                            <div class="invalid-feedback">{{ form.kontakt_osoba.errors[0] }}</div>
                        {% endif %}
                        <small class="form-text text-muted">Ime i prezime kontakt osobe u firmi (opciono).</small>
                    </div>
                    <div class="col-md-12">
                        <label for="napomene" class="form-label fw-semibold">
                            <i class="fa-solid fa-sticky-note me-1 text-muted"></i> Dodatne Napomene (opciono)
                        </label>
                        {{ form.napomene(class="form-control form-control-lg" ~ (" is-invalid" if form.napomene.errors else ""), id="napomene", rows="3", placeholder="Unesite dodatne napomene o komitentu") }}
                        {% if form.napomene.errors %}
                            <div class="invalid-feedback">{{ form.napomene.errors[0] }}</div>
                        {% endif %}
                        <small class="form-text text-muted">Dodatne napomene o komitentu (opciono).</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Submit Buttons -->
        <div class="card border-0 shadow-sm">
            <div class="card-body p-4">
                <div class="d-flex flex-wrap gap-2">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fa-solid fa-save me-2"></i> Sačuvaj Komitenta
                    </button>
                    <a href="{{ url_for('komitenti.lista') }}" class="btn btn-outline-secondary btn-lg">
                        <i class="fa-solid fa-times me-2"></i> Otkaži
                    </a>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
// NBS Search
document.getElementById('nbsSearchBtn').addEventListener('click', function() {
    const pib = document.getElementById('pib').value.trim();
    const alertDiv = document.getElementById('nbsAlert');

    if (!pib || (pib.length !== 8 && pib.length !== 9)) {
        alertDiv.className = 'alert alert-warning';
        alertDiv.textContent = 'Molimo unesite validan PIB (8 ili 9 cifara).';
        alertDiv.style.display = 'block';
        return;
    }

    // Show loading state
    this.disabled = true;
    this.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Pretražujem...';

    fetch(`/komitenti/api/nbs/firma/${pib}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.data) {
                // Auto-fill form fields
                document.getElementById('naziv').value = data.data.naziv || '';
                document.getElementById('maticni_broj').value = data.data.maticni_broj || '';
                document.getElementById('adresa').value = data.data.adresa || '';
                document.getElementById('broj').value = data.data.broj || 'bb';
                document.getElementById('mesto').value = data.data.mesto || '';

                // Set postanski_broj if available (NBS may not always provide this)
                if (data.data.postanski_broj) {
                    document.getElementById('postanski_broj').value = data.data.postanski_broj;
                }

                // Make fields readonly (can be overridden manually via double-click)
                ['naziv', 'maticni_broj', 'adresa', 'broj', 'mesto'].forEach(id => {
                    const field = document.getElementById(id);
                    field.setAttribute('readonly', true);
                    field.classList.add('bg-light');
                });

                alertDiv.className = 'alert alert-success';
                alertDiv.innerHTML = '<i class="fa-solid fa-check-circle"></i> Podaci uspešno preuzeti iz NBS baze! Dvoklik na polje za ručno menjanje.';
                alertDiv.style.display = 'block';
            } else {
                alertDiv.className = 'alert alert-warning';
                alertDiv.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i> ' + (data.message || 'Komitent nije pronađen u NBS bazi. Molimo unesite podatke ručno.');
                alertDiv.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('NBS API error:', error);
            alertDiv.className = 'alert alert-danger';
            alertDiv.innerHTML = '<i class="fa-solid fa-circle-exclamation"></i> Greška pri pretrazi NBS baze. Molimo unesite podatke ručno.';
            alertDiv.style.display = 'block';
        })
        .finally(() => {
            this.disabled = false;
            this.innerHTML = '<i class="fa-solid fa-magnifying-glass"></i> Pretraži NBS';
        });
});

// Allow manual override of readonly fields via double-click
['naziv', 'maticni_broj', 'adresa', 'broj', 'mesto'].forEach(id => {
    const field = document.getElementById(id);
    field.addEventListener('dblclick', function() {
        this.removeAttribute('readonly');
        this.classList.remove('bg-light');
        this.focus();
    });
});
</script>
{% endblock %}

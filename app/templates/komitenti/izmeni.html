{% extends "base.html" %}
{% from "macros/breadcrumbs.html" import render_breadcrumbs %}

{% block title %}Izmeni Komitenta - OBVEZNIK{% endblock %}

{% block breadcrumbs %}
{{ render_breadcrumbs([
    {'text': 'Dashboard', 'url': url_for('dashboard.pausalac_dashboard') if current_user.role != 'admin' else url_for('admin_dashboard.dashboard')},
    {'text': 'Komitenti', 'url': url_for('komitenti.lista')},
    {'text': komitent.naziv, 'url': url_for('komitenti.detail', id=komitent.id)},
    {'text': 'Izmeni', 'url': ''}
]) }}
{% endblock %}

{% block content %}
<div class="container mt-4 mb-5">
    <div class="d-flex align-items-center mb-4">
        <div class="bg-light rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 60px; height: 60px;">
            <i class="fa-solid fa-user-pen fs-3 text-muted"></i>
        </div>
        <div>
            <h1 class="mb-1">Izmeni Komitenta</h1>
            <p class="text-muted mb-0">{{ komitent.naziv }}</p>
        </div>
    </div>

    <form method="POST" action="{{ url_for('komitenti.izmeni', id=komitent.id) }}">
        {{ form.hidden_tag() }}

        <!-- PIB (Readonly) -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-bottom">
                <h5 class="mb-0"><i class="fa-solid fa-hashtag me-2 text-warning"></i> PIB</h5>
            </div>
            <div class="card-body p-4">
                <label for="pib" class="form-label fw-semibold">
                    <i class="fa-solid fa-hashtag me-1 text-muted"></i> PIB *
                </label>
                {{ form.pib(class="form-control form-control-lg bg-light", id="pib", readonly=true) }}
                <small class="form-text text-muted"><i class="fa-solid fa-lock me-1"></i> PIB ne može biti izmenjen nakon kreiranja komitenta.</small>
            </div>
        </div>

        <!-- Company Basic Info -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-bottom">
                <h5 class="mb-0"><i class="fa-solid fa-building me-2 text-primary"></i> Osnovni Podaci</h5>
            </div>
            <div class="card-body p-4">
                <div class="row g-3">
                    <div class="col-md-12">
                        <label for="naziv" class="form-label fw-semibold">
                            <i class="fa-solid fa-building me-1 text-muted"></i> Naziv Komitenta *
                        </label>
                        {{ form.naziv(class="form-control form-control-lg" ~ (" is-invalid" if form.naziv.errors else ""), id="naziv", placeholder="Unesite naziv komitenta") }}
                        {% if form.naziv.errors %}
                            <div class="invalid-feedback">{{ form.naziv.errors[0] }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <label for="maticni_broj" class="form-label fw-semibold">
                            <i class="fa-solid fa-id-card me-1 text-muted"></i> Matični Broj *
                        </label>
                        {{ form.maticni_broj(class="form-control form-control-lg" ~ (" is-invalid" if form.maticni_broj.errors else ""), id="maticni_broj", placeholder="Matični broj") }}
                        {% if form.maticni_broj.errors %}
                            <div class="invalid-feedback">{{ form.maticni_broj.errors[0] }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Address Info -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-bottom">
                <h5 class="mb-0"><i class="fa-solid fa-map-marker-alt me-2 text-success"></i> Adresa</h5>
            </div>
            <div class="card-body p-4">
                <div class="row g-3">
                    <div class="col-md-8">
                        <label for="adresa" class="form-label fw-semibold">
                            <i class="fa-solid fa-road me-1 text-muted"></i> Ulica *
                        </label>
                        {{ form.adresa(class="form-control form-control-lg" ~ (" is-invalid" if form.adresa.errors else ""), id="adresa", placeholder="Naziv ulice") }}
                        {% if form.adresa.errors %}
                            <div class="invalid-feedback">{{ form.adresa.errors[0] }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-4">
                        <label for="broj" class="form-label fw-semibold">
                            <i class="fa-solid fa-hashtag me-1 text-muted"></i> Broj *
                        </label>
                        {{ form.broj(class="form-control form-control-lg" ~ (" is-invalid" if form.broj.errors else ""), id="broj", placeholder="Broj") }}
                        {% if form.broj.errors %}
                            <div class="invalid-feedback">{{ form.broj.errors[0] }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-4">
                        <label for="postanski_broj" class="form-label fw-semibold">
                            <i class="fa-solid fa-envelope me-1 text-muted"></i> Poštanski Broj *
                        </label>
                        {{ form.postanski_broj(class="form-control form-control-lg" ~ (" is-invalid" if form.postanski_broj.errors else ""), id="postanski_broj", placeholder="Poštanski broj") }}
                        {% if form.postanski_broj.errors %}
                            <div class="invalid-feedback">{{ form.postanski_broj.errors[0] }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-4">
                        <label for="mesto" class="form-label fw-semibold">
                            <i class="fa-solid fa-city me-1 text-muted"></i> Mesto *
                        </label>
                        {{ form.mesto(class="form-control form-control-lg" ~ (" is-invalid" if form.mesto.errors else ""), id="mesto", placeholder="Naziv mesta") }}
                        {% if form.mesto.errors %}
                            <div class="invalid-feedback">{{ form.mesto.errors[0] }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-4">
                        <label for="drzava" class="form-label fw-semibold">
                            <i class="fa-solid fa-flag me-1 text-muted"></i> Država *
                        </label>
                        {{ form.drzava(class="form-control form-control-lg" ~ (" is-invalid" if form.drzava.errors else ""), id="drzava", placeholder="Država") }}
                        {% if form.drzava.errors %}
                            <div class="invalid-feedback">{{ form.drzava.errors[0] }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Contact Info -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-bottom">
                <h5 class="mb-0"><i class="fa-solid fa-address-card me-2 text-info"></i> Kontakt Informacije</h5>
            </div>
            <div class="card-body p-4">
                <div class="row g-3">
                    <div class="col-md-12">
                        <label for="email" class="form-label fw-semibold">
                            <i class="fa-solid fa-envelope me-1 text-muted"></i> Email *
                        </label>
                        {{ form.email(class="form-control form-control-lg" ~ (" is-invalid" if form.email.errors else ""), id="email", placeholder="email@primer.com") }}
                        {% if form.email.errors %}
                            <div class="invalid-feedback">{{ form.email.errors[0] }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-12">
                        <label for="kontakt_osoba" class="form-label fw-semibold">
                            <i class="fa-solid fa-user me-1 text-muted"></i> Kontakt Osoba (opciono)
                        </label>
                        {{ form.kontakt_osoba(class="form-control form-control-lg" ~ (" is-invalid" if form.kontakt_osoba.errors else ""), id="kontakt_osoba", placeholder="Ime i prezime kontakt osobe") }}
                        {% if form.kontakt_osoba.errors %}
                            <div class="invalid-feedback">{{ form.kontakt_osoba.errors[0] }}</div>
                        {% endif %}
                        <small class="form-text text-muted">Ime i prezime kontakt osobe u firmi (opciono).</small>
                    </div>
                    <div class="col-md-12">
                        <label for="napomene" class="form-label fw-semibold">
                            <i class="fa-solid fa-sticky-note me-1 text-muted"></i> Dodatne Napomene (opciono)
                        </label>
                        {{ form.napomene(class="form-control form-control-lg" ~ (" is-invalid" if form.napomene.errors else ""), id="napomene", rows="3", placeholder="Unesite dodatne napomene o komitentu") }}
                        {% if form.napomene.errors %}
                            <div class="invalid-feedback">{{ form.napomene.errors[0] }}</div>
                        {% endif %}
                        <small class="form-text text-muted">Dodatne napomene o komitentu (opciono).</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dinarski Računi -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-bottom">
                <h5 class="mb-0"><i class="fa-solid fa-money-bill me-2 text-warning"></i> Dinarski Računi (opciono)</h5>
            </div>
            <div class="card-body p-4">
                <div id="dinarskiRacuniContainer"></div>
                <button type="button" id="addDinarskiRacun" class="btn btn-outline-primary mt-3">
                    <i class="fa-solid fa-plus me-2"></i> Dodaj Dinarski Račun
                </button>
            </div>
        </div>

        <!-- Devizni Računi -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-bottom">
                <h5 class="mb-0"><i class="fa-solid fa-dollar-sign me-2 text-success"></i> Devizni Računi</h5>
            </div>
            <div class="card-body p-4">
                <div class="alert alert-info">
                    <i class="fa-solid fa-info-circle me-2"></i>
                    <strong>Napomena:</strong> Bar jedan devizni račun je obavezan za kreiranje deviznih faktura.
                </div>
                <div id="devizniRacuniContainer"></div>
                <button type="button" id="addDevizniRacun" class="btn btn-outline-success mt-3">
                    <i class="fa-solid fa-plus me-2"></i> Dodaj Devizni Račun
                </button>
            </div>
        </div>

        <!-- Hidden fields for JSON data -->
        {{ form.dinarski_racuni_json }}
        {{ form.devizni_racuni_json }}

        <!-- Submit Buttons -->
        <div class="card border-0 shadow-sm">
            <div class="card-body p-4">
                <div class="d-flex flex-wrap gap-2">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fa-solid fa-save me-2"></i> Sačuvaj Izmene
                    </button>
                    <a href="{{ url_for('komitenti.detail', id=komitent.id) }}" class="btn btn-outline-secondary btn-lg">
                        <i class="fa-solid fa-times me-2"></i> Otkaži
                    </a>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
// Dynamic Dinarski Računi Management
let dinarskiRacuni = [];
const dinarskiContainer = document.getElementById('dinarskiRacuniContainer');

function renderDinarskiRacuni() {
    dinarskiContainer.innerHTML = '';
    dinarskiRacuni.forEach((racun, index) => {
        const div = document.createElement('div');
        div.className = 'card mb-2';
        div.innerHTML = `
            <div class="card-body">
                <div class="row">
                    <div class="col-md-5">
                        <input type="text" class="form-control" placeholder="Naziv banke" value="${racun.banka}" onchange="updateDinarskiRacun(${index}, 'banka', this.value)">
                    </div>
                    <div class="col-md-5">
                        <input type="text" class="form-control" placeholder="Broj računa (###-###########-##)" value="${racun.racun}" onchange="updateDinarskiRacun(${index}, 'racun', this.value)">
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-danger w-100" onclick="removeDinarskiRacun(${index})">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        dinarskiContainer.appendChild(div);
    });
    document.getElementById('dinarski_racuni_json').value = JSON.stringify(dinarskiRacuni);
}

function addDinarskiRacun() {
    dinarskiRacuni.push({ banka: '', racun: '' });
    renderDinarskiRacuni();
}

function removeDinarskiRacun(index) {
    dinarskiRacuni.splice(index, 1);
    renderDinarskiRacuni();
}

function updateDinarskiRacun(index, field, value) {
    dinarskiRacuni[index][field] = value;
    document.getElementById('dinarski_racuni_json').value = JSON.stringify(dinarskiRacuni);
}

document.getElementById('addDinarskiRacun').addEventListener('click', addDinarskiRacun);

// Dynamic Devizni Računi Management
let devizniRacuni = [];
const devizniContainer = document.getElementById('devizniRacuniContainer');

function renderDevizniRacuni() {
    devizniContainer.innerHTML = '';
    devizniRacuni.forEach((racun, index) => {
        const div = document.createElement('div');
        div.className = 'card mb-2';
        div.innerHTML = `
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <input type="text" class="form-control" placeholder="Naziv banke" value="${racun.banka}" onchange="updateDevizniRacun(${index}, 'banka', this.value)">
                    </div>
                    <div class="col-md-3">
                        <input type="text" class="form-control" placeholder="IBAN" value="${racun.iban}" onchange="updateDevizniRacun(${index}, 'iban', this.value)">
                    </div>
                    <div class="col-md-2">
                        <input type="text" class="form-control" placeholder="SWIFT" value="${racun.swift}" onchange="updateDevizniRacun(${index}, 'swift', this.value)">
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" onchange="updateDevizniRacun(${index}, 'valuta', this.value)">
                            <option value="EUR" ${racun.valuta === 'EUR' ? 'selected' : ''}>EUR</option>
                            <option value="USD" ${racun.valuta === 'USD' ? 'selected' : ''}>USD</option>
                            <option value="GBP" ${racun.valuta === 'GBP' ? 'selected' : ''}>GBP</option>
                            <option value="CHF" ${racun.valuta === 'CHF' ? 'selected' : ''}>CHF</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-danger w-100" onclick="removeDevizniRacun(${index})">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        devizniContainer.appendChild(div);
    });
    document.getElementById('devizni_racuni_json').value = JSON.stringify(devizniRacuni);
}

function addDevizniRacun() {
    devizniRacuni.push({ banka: '', iban: '', swift: '', valuta: 'EUR' });
    renderDevizniRacuni();
}

function removeDevizniRacun(index) {
    devizniRacuni.splice(index, 1);
    renderDevizniRacuni();
}

function updateDevizniRacun(index, field, value) {
    devizniRacuni[index][field] = value;
    document.getElementById('devizni_racuni_json').value = JSON.stringify(devizniRacuni);
}

document.getElementById('addDevizniRacun').addEventListener('click', addDevizniRacun);

// Prepopulate existing data on page load
document.addEventListener('DOMContentLoaded', function() {
    // Load existing dinarski računi
    const dinarskiJsonField = document.getElementById('dinarski_racuni_json');
    if (dinarskiJsonField && dinarskiJsonField.value) {
        try {
            const existingDinarski = JSON.parse(dinarskiJsonField.value);
            if (Array.isArray(existingDinarski) && existingDinarski.length > 0) {
                dinarskiRacuni = existingDinarski;
                renderDinarskiRacuni();
            }
        } catch (e) {
            console.error('Error parsing dinarski računi:', e);
        }
    }

    // Load existing devizni računi
    const devizniJsonField = document.getElementById('devizni_racuni_json');
    if (devizniJsonField && devizniJsonField.value) {
        try {
            const existingDevizni = JSON.parse(devizniJsonField.value);
            if (Array.isArray(existingDevizni) && existingDevizni.length > 0) {
                devizniRacuni = existingDevizni;
                renderDevizniRacuni();
            }
        } catch (e) {
            console.error('Error parsing devizni računi:', e);
        }
    }
});
</script>
{% endblock %}

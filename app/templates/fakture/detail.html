{% extends "base.html" %}

{% block title %}Faktura {{ faktura.broj_fakture }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Faktura {{ faktura.broj_fakture }}</h2>

    <div class="card mb-3">
        <div class="card-body">
            <h5>Status: <span class="badge bg-{{ 'warning' if faktura.status == 'draft' else 'success' }}">{{ faktura.status }}</span></h5>
            <p><strong>Tip fakture:</strong> {{ faktura.tip_fakture|capitalize }}</p>
            <p><strong>Komitent:</strong> {{ faktura.komitent.naziv }}</p>
            <p><strong>Datum prometa:</strong> {{ faktura.datum_prometa }}</p>
            <p><strong>Datum dospeća:</strong> {{ faktura.datum_dospeca }}</p>

            {% if faktura.tip_fakture == 'devizna' %}
            <!-- Foreign Currency Invoice Info -->
            <p><strong>Valuta fakture:</strong> {{ faktura.valuta_fakture }}</p>
            <p><strong>Srednji kurs NBS:</strong> {{ "%.4f"|format(faktura.srednji_kurs) }}</p>
            <p><strong>Ukupan iznos:</strong>
                <span class="text-primary fw-bold">{{ "%.2f"|format(faktura.ukupan_iznos_originalna_valuta) }} {{ faktura.valuta_fakture }}</span>
                <span class="text-muted">(RSD: {{ "%.2f"|format(faktura.ukupan_iznos_rsd) }})</span>
            </p>
            {% else %}
            <!-- Domestic Invoice Info (RSD only) -->
            <p><strong>Ukupan iznos:</strong> {{ "%.2f"|format(faktura.ukupan_iznos_rsd) }} RSD</p>
            {% endif %}
        </div>
    </div>

    <h4>Stavke</h4>
    <table class="table table-striped table-hover">
        <thead class="table-light">
            <tr>
                <th>#</th>
                <th>Naziv</th>
                <th>Količina</th>
                <th>Cena{% if faktura.tip_fakture == 'devizna' %} ({{ faktura.valuta_fakture }}){% endif %}</th>
                <th>Ukupno{% if faktura.tip_fakture == 'devizna' %} ({{ faktura.valuta_fakture }}){% endif %}</th>
            </tr>
        </thead>
        <tbody>
            {% for stavka in faktura.stavke %}
            <tr>
                <td>{{ stavka.redni_broj }}</td>
                <td>{{ stavka.naziv }}</td>
                <td>{{ stavka.kolicina }} {{ stavka.jedinica_mere }}</td>
                <td>
                    {% if faktura.tip_fakture == 'devizna' %}
                        {{ "%.2f"|format(stavka.cena) }} {{ faktura.valuta_fakture }}
                    {% else %}
                        {{ "%.2f"|format(stavka.cena) }} RSD
                    {% endif %}
                </td>
                <td>
                    {% if faktura.tip_fakture == 'devizna' %}
                        <strong>{{ "%.2f"|format(stavka.ukupno) }} {{ faktura.valuta_fakture }}</strong>
                        <br><small class="text-muted">({{ "%.2f"|format(stavka.ukupno * faktura.srednji_kurs) }} RSD)</small>
                    {% else %}
                        <strong>{{ "%.2f"|format(stavka.ukupno) }} RSD</strong>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot class="table-light">
            <tr>
                <td colspan="4" class="text-end"><strong>UKUPNO:</strong></td>
                <td>
                    {% if faktura.tip_fakture == 'devizna' %}
                        <strong class="text-primary">{{ "%.2f"|format(faktura.ukupan_iznos_originalna_valuta) }} {{ faktura.valuta_fakture }}</strong>
                        <br><small class="text-muted">({{ "%.2f"|format(faktura.ukupan_iznos_rsd) }} RSD)</small>
                    {% else %}
                        <strong class="text-success">{{ "%.2f"|format(faktura.ukupan_iznos_rsd) }} RSD</strong>
                    {% endif %}
                </td>
            </tr>
        </tfoot>
    </table>

    {% if faktura.status == 'draft' %}
    <div class="d-flex gap-2 mb-3">
        <a href="{{ url_for('fakture.edit_faktura', faktura_id=faktura.id) }}" class="btn btn-primary">
            <i class="bi bi-pencil-square"></i> Izmeni
        </a>
        <form method="POST" action="{{ url_for('fakture.finalizuj', faktura_id=faktura.id) }}" class="d-inline">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <button type="submit" class="btn btn-success">
                <i class="bi bi-check-circle"></i> Finalizuj Fakturu
            </button>
        </form>
    </div>
    {% endif %}

    {% if faktura.status == 'izdata' %}
    <div class="mt-3">
        {% if faktura.status_pdf == 'generating' %}
        <!-- PDF generation in progress -->
        <div class="alert alert-info">
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            <span id="pdf-status-message">PDF generisanje u toku... Provera za <span id="countdown">3</span>s</span>
        </div>
        <button type="button" class="btn btn-sm btn-outline-primary" onclick="checkPdfStatus()">
            <i class="bi bi-arrow-clockwise"></i> Proveri Odmah
        </button>
        {% elif faktura.status_pdf == 'generated' %}
        <!-- PDF generated successfully -->
        <a href="{{ url_for('fakture.download_pdf', faktura_id=faktura.id) }}" class="btn btn-primary">
            <i class="bi bi-download"></i> Preuzmi PDF
        </a>
        {% elif faktura.status_pdf == 'failed' %}
        <!-- PDF generation failed -->
        <div class="alert alert-danger">
            PDF generisanje neuspešno. Molimo pokušajte ponovo.
        </div>
        <button type="button" class="btn btn-warning" onclick="retryPdfGeneration({{ faktura.id }})">
            <i class="bi bi-arrow-clockwise"></i> Pokušaj ponovo
        </button>
        <div id="retry-status-{{ faktura.id }}" class="mt-2"></div>
        {% endif %}
    </div>
    {% endif %}

    <a href="{{ url_for('dashboard.pausalac_dashboard') }}" class="btn btn-secondary mt-3">Nazad na Dashboard</a>
</div>

<script>
// API URL-ovi generisani pomoću url_for za podršku subfolder deployments
const RETRY_PDF_URL_TEMPLATE = "{{ url_for('fakture.retry_pdf', faktura_id=0) }}".replace('/0/', '/');

// Auto-refresh countdown when PDF is generating
{% if faktura.status == 'izdata' and faktura.status_pdf == 'generating' %}
let countdown = 3;
const countdownInterval = setInterval(() => {
    countdown--;
    const countdownElement = document.getElementById('countdown');
    if (countdownElement) {
        countdownElement.textContent = countdown;
    }

    if (countdown <= 0) {
        clearInterval(countdownInterval);
        window.location.reload();
    }
}, 1000);

function checkPdfStatus() {
    clearInterval(countdownInterval);
    window.location.reload();
}
{% endif %}

function retryPdfGeneration(fakturaId) {
    // Show loading state
    const statusDiv = document.getElementById('retry-status-' + fakturaId);
    statusDiv.innerHTML = '<div class="alert alert-info"><span class="spinner-border spinner-border-sm me-2"></span>Pokušaj u toku...</div>';

    // Make AJAX request
    fetch(RETRY_PDF_URL_TEMPLATE + fakturaId + '/retry-pdf', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            statusDiv.innerHTML = '<div class="alert alert-success">' + data.message + '</div>';
            // Reload page after 2 seconds to show generating status
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            statusDiv.innerHTML = '<div class="alert alert-danger">Greška: ' + data.message + '</div>';
        }
    })
    .catch(error => {
        statusDiv.innerHTML = '<div class="alert alert-danger">Greška pri komunikaciji sa serverom.</div>';
        console.error('Error:', error);
    });
}
</script>

{% endblock %}

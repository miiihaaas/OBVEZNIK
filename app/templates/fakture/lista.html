{% extends "base.html" %}
{% from "macros/breadcrumbs.html" import render_breadcrumbs %}
{% from "macros/empty_state.html" import render_empty_state %}
{% from "macros/pagination.html" import render_pagination %}
{% from "macros/page_header.html" import render_page_header %}

{% block title %}Fakture - OBVEZNIK{% endblock %}

{% block breadcrumbs %}
{{ render_breadcrumbs([
    {'text': 'Dashboard', 'url': url_for('dashboard.pausalac_dashboard') if current_user.role != 'admin' else url_for('admin_dashboard.dashboard')},
    {'text': 'Fakture', 'url': ''}
]) }}
{% endblock %}

{% block content %}
<div class="container mt-4 mb-5">
    <!-- Page Header -->
    {{ render_page_header(
        title='Admin - Sve Fakture' if current_user.role == 'admin' else 'Moje Fakture',
        subtitle='Pregled svih kreiranih faktura' if not pagination else None,
        icon='fa-solid fa-file-invoice',
        icon_style='inline',
        primary_action={
            'url': url_for('fakture.nova_faktura'),
            'text': 'Kreiraj Novu Fakturu',
            'icon': 'fa-solid fa-plus-circle',
            'size': 'normal'
        },
        layout='row',
        show_count_info=True if pagination else False,
        pagination=pagination
    ) }}

    <!-- Filters & Search -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <form method="GET" action="{{ url_for('fakture.lista') }}" class="row g-3 align-items-end">
                        <!-- Search Box -->
                        <div class="col-md-3">
                            <label class="form-label small text-muted">
                                <i class="fa-solid fa-search me-1"></i> Pretraži po broju
                            </label>
                            <input type="text" name="search" class="form-control" placeholder="npr. MK-001" value="{{ filters.get('search', '') }}">
                        </div>

                        <!-- Status Filter -->
                        <div class="col-md-2">
                            <label class="form-label small text-muted">Status</label>
                            <select name="status" class="form-select">
                                <option value="">Sve</option>
                                <option value="draft" {% if filters.get('status') == 'draft' %}selected{% endif %}>Nacrt</option>
                                <option value="izdata" {% if filters.get('status') == 'izdata' %}selected{% endif %}>Izdata</option>
                                <option value="stornirana" {% if filters.get('status') == 'stornirana' %}selected{% endif %}>Stornirana</option>
                                <option value="konvertovana" {% if filters.get('status') == 'konvertovana' %}selected{% endif %}>Konvertovana</option>
                            </select>
                        </div>

                        <!-- Tip Fakture Filter (Story 4.1) -->
                        <div class="col-md-2">
                            <label class="form-label small text-muted">Tip Fakture</label>
                            <select name="tip_fakture" class="form-select">
                                <option value="">Sve</option>
                                <option value="standardna" {% if filters.get('tip_fakture') == 'standardna' %}selected{% endif %}>Standardna</option>
                                <option value="profaktura" {% if filters.get('tip_fakture') == 'profaktura' %}selected{% endif %}>Profaktura</option>
                                <option value="avansna" {% if filters.get('tip_fakture') == 'avansna' %}selected{% endif %}>Avansna</option>
                                <option value="devizna" {% if filters.get('tip_fakture') == 'devizna' %}selected{% endif %}>Devizna</option>
                            </select>
                        </div>

                        <!-- Valuta Filter -->
                        <div class="col-md-2">
                            <label class="form-label small text-muted">Valuta</label>
                            <select name="valuta" class="form-select">
                                <option value="">Sve</option>
                                <option value="RSD" {% if filters.get('valuta') == 'RSD' %}selected{% endif %}>RSD</option>
                                <option value="EUR" {% if filters.get('valuta') == 'EUR' %}selected{% endif %}>EUR</option>
                                <option value="USD" {% if filters.get('valuta') == 'USD' %}selected{% endif %}>USD</option>
                                <option value="GBP" {% if filters.get('valuta') == 'GBP' %}selected{% endif %}>GBP</option>
                                <option value="CHF" {% if filters.get('valuta') == 'CHF' %}selected{% endif %}>CHF</option>
                            </select>
                        </div>

                        <!-- Date Range -->
                        <div class="col-md-2">
                            <label class="form-label small text-muted">Datum od</label>
                            <input type="date" name="datum_od" class="form-control" value="{{ filters.get('datum_od', '').strftime('%Y-%m-%d') if filters.get('datum_od') else '' }}">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small text-muted">Datum do</label>
                            <input type="date" name="datum_do" class="form-control" value="{{ filters.get('datum_do', '').strftime('%Y-%m-%d') if filters.get('datum_do') else '' }}">
                        </div>

                        <!-- Admin Firma Filter -->
                        {% if current_user.role == 'admin' and all_firme %}
                        <div class="col-md-3">
                            <label class="form-label small text-muted">Firma</label>
                            <select name="firma_id" class="form-select">
                                <option value="">Sve firme</option>
                                {% for firma in all_firme %}
                                <option value="{{ firma.id }}" {% if filters.get('firma_id') == firma.id %}selected{% endif %}>
                                    {{ firma.naziv }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        {% endif %}

                        <!-- Action Buttons -->
                        <div class="col-md-{% if current_user.role == 'admin' %}4{% else %}3{% endif %} d-flex gap-2">
                            <button type="submit" class="btn btn-primary flex-grow-1">
                                <i class="fa-solid fa-filter me-1"></i> Primeni
                            </button>
                            <a href="{{ url_for('fakture.lista') }}" class="btn btn-outline-secondary">
                                <i class="fa-solid fa-times me-1"></i> Resetuj
                            </a>
                        </div>

                        <!-- Preserve sorting parameters -->
                        <input type="hidden" name="sort_by" value="{{ sort_by }}">
                        <input type="hidden" name="sort_order" value="{{ sort_order }}">
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Fakture Table -->
    {% if pagination and pagination.items %}
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <!-- Sortable Header: Broj Fakture -->
                                    <th class="px-4 py-3">
                                        <a href="?sort_by=broj_fakture&sort_order={% if sort_by == 'broj_fakture' and sort_order == 'asc' %}desc{% else %}asc{% endif %}{% for key, value in request.args.items() %}{% if key not in ['sort_by', 'sort_order', 'page'] %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="text-decoration-none text-dark">
                                            Broj Fakture
                                            {% if sort_by == 'broj_fakture' %}
                                                <i class="fa-solid fa-sort-{{ 'up' if sort_order == 'asc' else 'down' }}"></i>
                                            {% else %}
                                                <i class="fa-solid fa-sort text-muted"></i>
                                            {% endif %}
                                        </a>
                                    </th>

                                    <!-- Sortable Header: Datum Prometa -->
                                    <th class="py-3">
                                        <a href="?sort_by=datum_prometa&sort_order={% if sort_by == 'datum_prometa' and sort_order == 'asc' %}desc{% else %}asc{% endif %}{% for key, value in request.args.items() %}{% if key not in ['sort_by', 'sort_order', 'page'] %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="text-decoration-none text-dark">
                                            Datum Prometa
                                            {% if sort_by == 'datum_prometa' %}
                                                <i class="fa-solid fa-sort-{{ 'up' if sort_order == 'asc' else 'down' }}"></i>
                                            {% else %}
                                                <i class="fa-solid fa-sort text-muted"></i>
                                            {% endif %}
                                        </a>
                                    </th>

                                    <!-- Tip Fakture Column (Story 4.1) -->
                                    <th class="py-3">Tip</th>

                                    <th class="py-3">Komitent</th>
                                    <th class="py-3">Valuta</th>

                                    <!-- Sortable Header: Ukupan Iznos -->
                                    <th class="py-3 text-end">
                                        <a href="?sort_by=ukupan_iznos_rsd&sort_order={% if sort_by == 'ukupan_iznos_rsd' and sort_order == 'asc' %}desc{% else %}asc{% endif %}{% for key, value in request.args.items() %}{% if key not in ['sort_by', 'sort_order', 'page'] %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="text-decoration-none text-dark">
                                            Iznos
                                            {% if sort_by == 'ukupan_iznos_rsd' %}
                                                <i class="fa-solid fa-sort-{{ 'up' if sort_order == 'asc' else 'down' }}"></i>
                                            {% else %}
                                                <i class="fa-solid fa-sort text-muted"></i>
                                            {% endif %}
                                        </a>
                                    </th>

                                    <th class="py-3 text-center">Status</th>

                                    <!-- Admin-only Firma column -->
                                    {% if current_user.role == 'admin' %}
                                    <th class="py-3">Firma</th>
                                    {% endif %}

                                    <th class="py-3 text-center">Akcije</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for faktura in pagination.items %}
                                <tr{% if faktura.status == 'stornirana' %} class="text-danger"{% endif %}>
                                    <td class="px-4 py-3">
                                        <a href="{{ url_for('fakture.detail', faktura_id=faktura.id) }}" class="text-decoration-none fw-semibold{% if faktura.status == 'stornirana' %} text-danger{% endif %}">
                                            <i class="fa-solid fa-file-invoice me-1 text-muted"></i>
                                            {% if faktura.status == 'stornirana' %}<s>{{ faktura.broj_fakture }}</s>{% else %}{{ faktura.broj_fakture }}{% endif %}
                                        </a>
                                    </td>
                                    <td class="py-3">
                                        <i class="fa-regular fa-calendar me-1 text-muted"></i>
                                        {{ faktura.datum_prometa.strftime('%d.%m.%Y') }}
                                    </td>
                                    <!-- Tip Fakture Badge (Story 4.1) -->
                                    <td class="py-3">
                                        {% if faktura.tip_fakture == 'profaktura' %}
                                            <span class="badge bg-info">Profaktura</span>
                                        {% elif faktura.tip_fakture == 'avansna' %}
                                            <span class="badge bg-warning text-dark">Avansna</span>
                                        {% elif faktura.tip_fakture == 'devizna' %}
                                            <span class="badge bg-primary">Devizna</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Standardna</span>
                                        {% endif %}

                                        <!-- Story 4.2: Link ka profakturi iz koje je faktura nastala -->
                                        {% if faktura.konvertovana_iz_profakture_id %}
                                        <br>
                                        <small>
                                            <a href="{{ url_for('fakture.detail', faktura_id=faktura.konvertovana_iz_profakture_id) }}"
                                               class="text-decoration-none text-muted"
                                               title="Pogledaj profakturu">
                                                <i class="fa-solid fa-arrow-left me-1"></i> iz Profakture
                                            </a>
                                        </small>
                                        {% endif %}

                                        <!-- Story 4.4: Link ka avansu koji ova faktura zatvara -->
                                        {% if faktura.avansna_faktura_id %}
                                        <br>
                                        <small>
                                            <a href="{{ url_for('fakture.detail', faktura_id=faktura.avansna_faktura_id) }}"
                                               class="text-decoration-none text-muted"
                                               title="Pogledaj avansnu fakturu">
                                                <i class="fa-solid fa-receipt me-1"></i> zatvara Avans
                                            </a>
                                        </small>
                                        {% endif %}
                                    </td>
                                    <td class="py-3">
                                        <div class="fw-semibold">{{ faktura.komitent.naziv }}</div>
                                        <small class="text-muted">PIB: {{ faktura.komitent.pib }}</small>
                                    </td>
                                    <td class="py-3">
                                        <span class="badge bg-secondary">{{ faktura.valuta_fakture }}</span>
                                    </td>
                                    <td class="py-3 text-end fw-semibold">
                                        {% if faktura.valuta_fakture != 'RSD' and faktura.ukupan_iznos_originalna_valuta %}
                                            {{ '{:,.2f}'.format(faktura.ukupan_iznos_originalna_valuta).replace(',', ' ').replace('.', ',') }} {{ faktura.valuta_fakture }}
                                            <br>
                                            <small class="text-muted">({{ '{:,.2f}'.format(faktura.ukupan_iznos_rsd).replace(',', ' ').replace('.', ',') }} RSD)</small>
                                        {% else %}
                                            {{ '{:,.2f}'.format(faktura.ukupan_iznos_rsd).replace(',', ' ').replace('.', ',') }} RSD
                                        {% endif %}
                                    </td>
                                    <td class="py-3 text-center">
                                        {% if faktura.status == 'draft' %}
                                            <span class="badge bg-secondary">
                                                <i class="fa-solid fa-pencil me-1"></i> Nacrt
                                            </span>
                                        {% elif faktura.status == 'izdata' %}
                                            <span class="badge bg-success">
                                                <i class="fa-solid fa-check me-1"></i> Izdata
                                            </span>
                                        {% elif faktura.status == 'stornirana' %}
                                            <span class="badge bg-danger">
                                                <i class="fa-solid fa-ban me-1"></i> Stornirana
                                            </span>
                                        {% elif faktura.status == 'konvertovana' %}
                                            <span class="badge bg-warning">
                                                <i class="fa-solid fa-arrow-right-circle me-1"></i> Konvertovana
                                            </span>
                                            {% if faktura.konvertovana_u_fakturu_id %}
                                            <br>
                                            <small>
                                                <a href="{{ url_for('fakture.detail', faktura_id=faktura.konvertovana_u_fakturu_id) }}"
                                                   class="text-decoration-none"
                                                   title="Pogledaj fakturu">
                                                    <i class="fa-solid fa-arrow-right me-1"></i> Faktura
                                                </a>
                                            </small>
                                            {% endif %}
                                        {% elif faktura.status == 'zatvorena' %}
                                            <!-- Story 4.4: Status "Zatvorena" za avansne fakture -->
                                            <span class="badge bg-info">
                                                <i class="fa-solid fa-lock me-1"></i> Zatvorena
                                            </span>
                                            {% if faktura.konvertovana_u_fakturu_id %}
                                            <br>
                                            <small>
                                                <a href="{{ url_for('fakture.detail', faktura_id=faktura.konvertovana_u_fakturu_id) }}"
                                                   class="text-decoration-none"
                                                   title="Pogledaj finalnu fakturu">
                                                    <i class="fa-solid fa-arrow-right me-1"></i> Finalna faktura
                                                </a>
                                            </small>
                                            {% endif %}
                                        {% endif %}
                                    </td>

                                    <!-- Admin-only Firma column -->
                                    {% if current_user.role == 'admin' %}
                                    <td class="py-3">
                                        <small>{{ faktura.firma.naziv }}</small>
                                    </td>
                                    {% endif %}

                                    <!-- Quick Actions -->
                                    <td class="py-3 text-center">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <!-- Pregled -->
                                            <a href="{{ url_for('fakture.detail', faktura_id=faktura.id) }}"
                                               class="btn btn-outline-primary"
                                               title="Pogledaj detalje"
                                               aria-label="Pogledaj detalje fakture {{ faktura.broj_fakture }}">
                                                <i class="fa-solid fa-eye"></i>
                                            </a>

                                            <!-- Preuzmi PDF (only if PDF exists) -->
                                            {% if faktura.status == 'izdata' and faktura.pdf_url %}
                                            <a href="{{ url_for('fakture.download_pdf', faktura_id=faktura.id) }}"
                                               class="btn btn-outline-secondary"
                                               title="Preuzmi PDF"
                                               aria-label="Preuzmi PDF fakture {{ faktura.broj_fakture }}">
                                                <i class="fa-solid fa-download"></i>
                                            </a>
                                            {% endif %}

                                            <!-- Pošalji Email (only if PDF exists) -->
                                            {% if faktura.status == 'izdata' and faktura.pdf_url %}
                                            <button type="button"
                                                    class="btn btn-outline-success"
                                                    title="Pošalji Email"
                                                    aria-label="Pošalji email fakture {{ faktura.broj_fakture }}"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#emailModal{{ faktura.id }}">
                                                <i class="fa-solid fa-envelope"></i>
                                            </button>
                                            {% endif %}

                                            <!-- Izmeni (only for draft) -->
                                            {% if faktura.status == 'draft' %}
                                            <a href="{{ url_for('fakture.edit_faktura', faktura_id=faktura.id) }}"
                                               class="btn btn-outline-warning"
                                               title="Izmeni"
                                               aria-label="Izmeni fakturu {{ faktura.broj_fakture }}">
                                                <i class="fa-solid fa-edit"></i>
                                            </a>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pagination Controls -->
    {{ render_pagination(
        pagination=pagination,
        endpoint='fakture.lista',
        preserve_args={
            'search': request.args.get('search', ''),
            'sort': request.args.get('sort', ''),
            'order': request.args.get('order', '')
        }
    ) }}

    {% else %}
    <!-- Empty State -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    {% if filters %}
                    {{ render_empty_state(
                        icon='search',
                        heading='Nije pronađena ni jedna faktura',
                        description='Pokušajte da promenite filtere ili resetujte pretragu.'
                    ) }}
                    <div class="text-center mt-3">
                        <a href="{{ url_for('fakture.lista') }}" class="btn btn-outline-secondary shadow-sm me-2">
                            <i class="fa-solid fa-times-circle me-2"></i>
                            Resetuj Filtere
                        </a>
                        <a href="{{ url_for('fakture.nova_faktura') }}" class="btn btn-primary shadow-sm">
                            <i class="fa-solid fa-plus-circle me-2"></i>
                            Kreiraj Novu Fakturu
                        </a>
                    </div>
                    {% else %}
                    {{ render_empty_state(
                        icon='folder-open',
                        heading='Nema faktura',
                        description='Još nema kreiranih faktura. Kliknite dugme ispod da kreirate prvu fakturu.',
                        cta_text='Kreiraj Novu Fakturu',
                        cta_url=url_for('fakture.nova_faktura')
                    ) }}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Email Modal Template (exists for each faktura) -->
{% if pagination and pagination.items %}
{% for faktura in pagination.items %}
{% if faktura.status == 'izdata' and faktura.pdf_url %}
<!-- Modal structure should be added here if email modal doesn't already exist globally -->
<!-- For now, assume email modal is handled in detail.html and can be reused -->
{% endif %}
{% endfor %}
{% endif %}

{% endblock %}
